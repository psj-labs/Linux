# Virtual Host_01

## 개요

- 본 문서는 Apache VirtualHost 기능과 DNS(Name Server)를 연동하여  
  하나의 서버에서 여러 IP와 여러 도메인을 기반으로 웹 서비스를 제공하는 과정을 정리한 학습 문서입니다.
- Apache의 IP 기반 VirtualHost 구성과  
  BIND(named)를 이용한 도메인 네임서버 구성을 함께 실습합니다.
- 디렉터리 BIND등 사전 세팅은 `01. Apache Server` 구축에서 다루었습니다.

---

## 네트워크 구성

- 다음과 같은 구성으로 실습을 진행합니다.  
![29](/Apache%20서버/imgs/29.png)

- 하나의 서버에서 두 개의 IP를 사용하므로  
  nmtui를 이용하여 IP 주소를 하나 추가합니다.

![14](/Apache%20서버/imgs/14.png)

- 변경된 네트워크 설정을 다음 명령어로 적용합니다.
```
nmcli connection up ens160
```
- ip a 명령어를 실행하여 IP가 정상적으로 추가된 것을 확인합니다.

![15](/Apache%20서버/imgs/15.png)

---

## Apache VirtualHost 설정

- Apache 설정 파일에 VirtualHost 설정을 추가합니다.
```
/app/apache/conf/httpd.conf
```
```
<VirtualHost 192.168.0.128:80>
    DocumentRoot /home/httpd/sec
    ServerName 192.168.0.128
</VirtualHost>

<VirtualHost 192.168.0.127:80>
    DocumentRoot /home/httpd/itc
    ServerName 192.168.0.127
</VirtualHost>
```
![16](/Apache%20서버/imgs/16.png)

### VirtualHost 설정 의미

- 해당 설정은 하나의 Apache 서버에서  
  서로 다른 IP 주소를 기준으로  
  각각 다른 DocumentRoot를 사용하도록 구성하는 IP 기반 VirtualHost 설정입니다.

- 의미는 다음과 같습니다.

  • 192.168.0.128:80으로 들어오는 요청은  
    `/home/httpd/sec` 디렉토리의 웹 페이지를 제공합니다.

  • 192.168.0.127:80으로 들어오는 요청은  
    `/home/httpd/itc` 디렉토리의 웹 페이지를 제공합니다.

- 즉, 같은 Apache 서버이지만  
  접속 IP에 따라 서로 다른 웹 사이트를 서비스하게 됩니다.

---

## 상위 DocumentRoot 접근 허용 설정

- 다음 설정을 추가하여 `/home/httpd` 디렉토리를  
  웹에서 접근 가능한 공식 웹 루트로 설정합니다.
- 해당 설정이 없을 경우 Apache는 `/home/httpd` 경로를 접근 불가능한 디렉토리로 판단하여  
  VirtualHost가 존재하더라도 `403 Forbidden` 오류가 발생합니다.

- 또한 ast10.sec, ast10.itc로 들어오는 요청은  
  먼저 `/home/httpd` 접근 허가를 통과한 후  
  각 VirtualHost의 DocumentRoot로 분기됩니다.
```
DocumentRoot "/home/httpd"

<Directory /home/httpd>
    Options FollowSymLinks
    Order allow,deny
    Allow from all
</Directory>
```
![24](/Apache%20서버/imgs/24.png)

---

## 웹 페이지 파일 생성

- webmaster 계정으로 각 VirtualHost에 해당하는 디렉토리에  
  index.html 파일을 생성합니다.

![17](/Apache%20서버/imgs/17.png)

---

## DNS 서버 구성

- 도메인으로 접속 시 해당 VirtualHost IP로 연결되도록  
  네임서버를 구성합니다.

- 다음은 `/etc/named.conf` 파일입니다.

![18](/Apache%20서버/imgs/18.png)

- ast10.sec와 ast10.itc 도메인을 구성합니다.

---

## ast10.sec Zone 파일

- 다음은 ast10.sec.zone 파일의 내용입니다.

![19](/Apache%20서버/imgs/19.png)

- 네임서버 IP는 192.168.0.129로 설정합니다.
- `ast10.sec` 및 `www.ast10.sec`의 호스트 IP는  
  192.168.0.128로 설정합니다.

![20](/Apache%20서버/imgs/20.png)

---

## ast10.itc Zone 파일

- 위 설정과 동일한 방식으로 ast10.itc.zone 파일을 구성합니다.
- 네임서버 IP는 192.168.0.129로 설정합니다.
- `ast10.itc` 및 `www.ast10.itc`의 호스트 IP는  
  192.168.0.127로 설정합니다.

---

## named 서비스 실행

- 다음 명령어로 DNS 서비스를 실행합니다.
```
systemctl start named
```
![21](/Apache%20서버/imgs/21.png)

---

## 클라이언트 DNS 설정

- 필자는 현재 사용하는 네트워크의 DNS 서버 주소를  
  네임서버 IP인 `192.168.0.129`로 설정합니다.

![22](/Apache%20서버/imgs/22.png)

---

## DNS 동작 확인

- 다른 터미널에서 도메인 질의를 수행하여  
  네임서버가 정상적으로 동작하는지 확인합니다.

![23](/Apache%20서버/imgs/23.png)

- 도메인에 대해 정상적인 IP 응답이 반환되는 것을 확인할 수 있습니다.

---

## Apache 서버 실행 및 테스트

- Apache 서버를 실행합니다.
```
/app/apache/bin/apachectl start
```
- IP `192.168.0.128`과 도메인 `www.ast10.sec`로 접속하여  
  설정한 페이지가 출력되는지 확인합니다.

![25](/Apache%20서버/imgs/25.png)
![26](/Apache%20서버/imgs/26.png)

- 이어서 IP `192.168.0.127`과 도메인 `www.ast10.itc`로 접속합니다.

![27](/Apache%20서버/imgs/27.png)
![28](/Apache%20서버/imgs/28.png)

- 두 도메인 모두 각각의 VirtualHost에 맞는 페이지가 정상적으로 출력됩니다.

---

## 정리

- 하나의 Apache 서버에서 여러 IP를 이용해 IP 기반 VirtualHost를 구성할 수 있습니다.
- VirtualHost는 접속 IP에 따라 서로 다른 DocumentRoot를 제공하는 기능입니다.
- VirtualHost 사용 시 상위 Directory 접근 허가 설정이 반드시 필요합니다.
- DNS 서버를 통해 도메인을 각 VirtualHost IP에 매핑할 수 있습니다.
