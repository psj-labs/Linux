# NFS 서버 구축 및 exports 설정

## 개요

- 본 문서는 Linux 환경에서 NFS(Network File System) 서버를 구축하고  
  `/etc/exports` 설정에 따라 파일 소유자와 그룹이 어떻게 매핑되는지를 실습으로 확인하는 학습 문서입니다.
- 서버와 클라이언트 환경을 분리하여  
  root 사용자와 일반 사용자 접근 시의 차이를 비교합니다.
- 특히 `root_squash`, `all_squash`, `no_root_squash`, `no_all_squash`,  
  `anonuid`, `anongid` 옵션의 실제 동작을 중점적으로 확인합니다.

---

## NFS 서버 구성

- NFS 서버와 클라이언트는 서로 다른 호스트로 구성합니다.
- 서버는 공유 디렉토리를 제공하며, 클라이언트는 이를 마운트하여 사용합니다.
- NFS 서버 구성도는 다음과 같습니다.  
![16](/NFS%20서버/imgs/16.png)  

---

## NFS 패키지 설치

- NFS 서버와 클라이언트 양쪽 모두 다음 패키지를 설치합니다.
```
dnf install -y nfs-utils
```
![01](/NFS%20서버/imgs/01.png)  
![02](/NFS%20서버/imgs/02.png)

---

## 관련 파일

- 데몬 : `/usr/sbin/exportfs`
- 서비스 파일 : `/usr/lib/systemd/system/nfs-server.service`  
- 환경 설정 파일 : `/etc/exports`  

---

## NFS 서버 자동 실행 설정

- 시스템 부팅 시 NFS 서버가 자동으로 실행되도록 설정합니다.
- ntsysv에서 `nfs-server.service`를 활성화합니다.

![03](/NFS%20서버/imgs/03.png)

---

## /etc/exports 기본 문법
```
[공유할 디렉토리] [허용할 클라이언트][(옵션)]
```
- 클라이언트는 단일 IP, 네트워크 주소(CIDR), 호스트명으로 지정할 수 있습니다.
- 예시
```
  203.228.182.0/24 → 해당 네트워크 전체 허용  
  *.example.com → 특정 도메인 전체 허용
```
---

## exports 옵션 설명

- `ro` : `읽기 전용`
- `rw` : `읽기 및 쓰기 허용`

- `root_squash1`
  `클라이언트의 root 사용자를 nobody로 매핑합니다. (기본 보안 옵션)`

- `no_root_squash`  
  `클라이언트의 root를 서버의 root로 그대로 매핑합니다.`

- `all_squash`  
  `root를 포함한 모든 사용자를 nobody로 매핑합니다.`

- `no_all_squash`  
  `일반 사용자의 UID/GID를 그대로 유지합니다.`

- `anonuid=UID, anongid=GID`  
  `nobody로 매핑될 경우 사용할 UID/GID를 강제로 지정합니다.`

※ NFS는 **계정 이름이 아닌 UID/GID 기준으로 권한을 판단합니다.**
※ nobody는 권한이 제거된 최소 권한의 익명 사용자로 **접근 주체를 특정할 수 없거나 권한을 의도적으로 낮출 때 사용하는 계정입니다.**

---

## exports 설정 내용

- 필자는 a1 ~ a8 디렉토리를 생성하고 다음과 같이 설정합니다.
```
/home/a1 192.168.64.26(rw,no_root_squash)  
/home/a2 192.168.64.26(rw,all_squash)  
/home/a3 192.168.64.26(rw,no_all_squash)  
/home/a4 192.168.64.26(rw,all_squash,root_squash)  
/home/a5 192.168.64.26(rw,all_squash,no_root_squash)  
/home/a6 192.168.64.26(rw,no_all_squash,root_squash)  
/home/a7 192.168.64.26(rw,no_all_squash,no_root_squash)  
/home/a8 192.168.64.26(rw,anonuid=5001,anongid=5000)
```
![04](/NFS%20서버/imgs/04.png)

---

## exports 옵션 조합 의미 요약

- `a1 (no_root_squash)`  
  `root 권한이 서버까지 그대로 전달됩니다.`

- `a2 (all_squash)`  
  `모든 사용자가 nobody로 처리됩니다.`

- `a3 (no_all_squash)`  
  `모든 사용자의 UID/GID가 그대로 유지됩니다.`

- `a4 (all_squash, root_squash)`  
  `모든 사용자가 nobody로 강제 매핑됩니다.`

- `a5 (all_squash, no_root_squash)`
  `일반 사용자는 nobody, root만 예외 처리됩니다.`

- `a6 (no_all_squash, root_squash)`  
  `일반 사용자는 유지, root만 제한됩니다.`

- `a7 (no_all_squash, no_root_squash)`  
  `모든 권한이 그대로 전달됩니다.`

- `a8 (anonuid, anongid)`  
  `squash 사용자를 특정 계정으로 통제합니다.`

---

## 공유 디렉토리 생성 (서버 측)
```
mkdir /home/a1 /home/a2 /home/a3 /home/a4 /home/a5 /home/a6 /home/a7 /home/a8
```
![05](/NFS%20서버/imgs/05.png)

---

## 실습용 계정 생성 (a8용)
```
groupadd -g 5000 test  
useradd -g 5000 -u 5001 ast10  
```
![06](/NFS%20서버/imgs/06.png)

---

## NFS 서버 실행 및 exports 적용
```
systemctl start nfs-server.service  
exportfs -rv
```
![07](/NFS%20서버/imgs/07.png)  
![09](/NFS%20서버/imgs/09.png)

---

## 클라이언트 측 마운트
```
mount 192.168.64.24:/home/a1 /home/a1  
mount 192.168.64.24:/home/a2 /home/a2  
mount 192.168.64.24:/home/a3 /home/a3  
mount 192.168.64.24:/home/a4 /home/a4  
mount 192.168.64.24:/home/a5 /home/a5  
mount 192.168.64.24:/home/a6 /home/a6  
mount 192.168.64.24:/home/a7 /home/a7  
mount 192.168.64.24:/home/a8 /home/a8  
```
![08](/NFS%20서버/imgs/08.png)

---

## root 사용자 파일 생성 결과 및 해석

![11](/NFS%20서버/imgs/11.png)

- `a1 (no_root_squash)`  
  `root_squash가 비활성화되어 root가 그대로 유지됩니다.`

- `a2 (all_squash)`  
  `root를 포함한 모든 사용자가 nobody로 처리됩니다.`

- `a3 (no_all_squash)`  
  `root의 UID/GID가 그대로 전달됩니다.`

- `a4 (all_squash, root_squash)` 
  `root가 squash 처리되어 nobody로 매핑됩니다.`

- `a5 (all_squash, no_root_squash)`  
  `root만 예외로 허용됩니다.`

- `a6 (no_all_squash, root_squash)`  
  `root만 제한됩니다.`

- `a7 (no_all_squash, no_root_squash)`  
  `root 권한이 그대로 전달됩니다.`

- `a8 (anonuid, anongid)`  
  `root가 지정된 UID/GID로 매핑됩니다.`

---

## 일반 사용자(ast10) 파일 생성 결과 및 해석

![13](/NFS%20서버/imgs/13.png)

- `a1 (no_root_squash)`  
 `일반 사용자는 squash 대상이 아닙니다.`

- `a2 (all_squash)`  
  `일반 사용자도 nobody로 처리됩니다.`

- `a3 (no_all_squash)`
  `UID/GID가 그대로 유지됩니다.`

- `a4 (all_squash, root_squash)`  
  `일반 사용자도 squash 처리됩니다.`

- `a5 (all_squash, no_root_squash)`  
  `일반 사용자는 squash 처리됩니다.`

- `a6 (no_all_squash, root_squash)`  
  `일반 사용자는 그대로 유지됩니다.`

- `a7 (no_all_squash, no_root_squash)`  
  `모든 사용자가 그대로 유지됩니다.`

- `a8 (anonuid, anongid)`  
  `일반 사용자도 지정된 계정으로 매핑됩니다.`

---

## 정리

- NFS는 UID/GID 기반으로 권한을 판단합니다.
- root_squash는 보안상 필수 옵션입니다.
- all_squash는 사용자 구분을 제거합니다.
- anonuid/anongid를 이용하면 익명 사용자 권한을 통제할 수 있습니다.
